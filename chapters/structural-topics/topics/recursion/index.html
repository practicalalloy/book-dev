<!doctype html>
<html class="no-js" lang="en" data-content_root="../../../../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="../../../../genindex.html" /><link rel="search" title="Search" href="../../../../search.html" /><link rel="next" title="Working with integers" href="../integers/index.html" /><link rel="prev" title="Module system" href="../modules/index.html" />

    <!-- Generated with Sphinx 7.2.6 and Furo 2024.01.29 -->
        <title>Handling recursion - Practical Alloy</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/styles/furo.css?v=135e06be" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/styles/furo-extensions.css?v=36a5483c" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  --color-brand-primary: #2a5adf;
  --color-brand-content: #2a5adf;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../../../index.html"><div class="brand">Practical Alloy</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../../../index.html">
  
  
  <span class="sidebar-brand-text">Practical Alloy</span>
  
</a><form class="sidebar-search-container" method="get" action="../../../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Preface</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../about-alloy/index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../about-book/index.html">About this book</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../writer-notes.html">Writer notes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">The Basics</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../structural-modeling/index.html">Structural modeling</a></li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="../../index.html">↳ Quick reads</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of ↳ Quick reads</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../subset-signatures/index.html">Subset signatures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../nary-relations/index.html">Higher-arity relations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../enumerations/index.html">Enumeration signatures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../commands/index.html">Commands in detail</a></li>
<li class="toctree-l2"><a class="reference internal" href="../themes/index.html">Visualization customization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../evaluator/index.html">The instance evaluator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing-instances/index.html">Encoding test instances</a></li>
<li class="toctree-l2"><a class="reference internal" href="../relational-logic/index.html">A relational logic primer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bestiary/index.html">Arrow multiplicity checks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ordering/index.html">The predefined <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">ordering</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html">Module system</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">Handling recursion</a></li>
<li class="toctree-l2"><a class="reference internal" href="../integers/index.html">Working with integers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../type-system/index.html">Type system</a></li>
<li class="toctree-l2"><a class="reference internal" href="../analysis/index.html">Structural analysis</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../behavioral-modeling/index.html">Behavioral modeling</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../behavioral-topics/index.html">↳ Quick reads</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of ↳ Quick reads</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../behavioral-topics/topics/mutable-toplevel-signatures/index.html">Mutable top-level signatures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../behavioral-topics/topics/event-depiction/index.html">An idiom for event depiction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../behavioral-topics/topics/scenarios/index.html">Encoding trace scenarios</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../behavioral-topics/topics/evaluator/index.html">The trace evaluator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../behavioral-topics/topics/temporal-logic/index.html">A temporal logic primer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../behavioral-topics/topics/pointwise-effects/index.html">Pointwise effects</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../behavioral-topics/topics/fairness/index.html">Safety, Liveness and Fairness</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../behavioral-topics/topics/sequences/index.html">Sequences</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../behavioral-topics/topics/macros/index.html">Macros</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../behavioral-topics/topics/meta/index.html">Meta-capabilities</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Applications</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../protocol-design/index.html">Protocol design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../app-design/index.html">App design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../interaction-design/index.html">Interaction design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../system-design/index.html">Controller design</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Resources</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../bibliography.html">Bibliography</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../genindex.html">Index</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="handling-recursion">
<h1>Handling recursion<a class="headerlink" href="#handling-recursion" title="Link to this heading">#</a></h1>
<p>The transitive closure operator supported by the Alloy language allows the
encoding of several computations that would otherwise have to be performed
through recursive definitions. Let us get back to the file system model defined
in the main chapter <a class="reference internal" href="../../../structural-modeling/index.html#structural-modeling"><span class="std std-ref">Structural modeling</span></a>. Assertion <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">no_partitions</span></code>
required the collection of all objects indirectly contained in the root,
traversing the complete file hierarchy. In a concrete implementation, this would
probably be computed with a recursive procedure. In Alloy, we easily collected
all objects using the transitive closure on <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">entries</span><span class="o">.</span><span class="n">object</span></code>. While
extremely useful, transitive closure cannot replace all recursive procedures.
For instance, let us try to compute the (maximum) depth of a file in the file
system. We could use the transitive closure of <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">entries</span><span class="o">.</span><span class="n">object</span></code> to
retrieve all ancestors of a certain file. However, files can be shared among
directories, and the result of the transitive closure would be a flat set of
objects without information about their provenance within the file system. Thus,
it cannot be used to calculate file depth.</p>
<section id="the-predefined-natural-module">
<h2>The predefined <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">natural</span></code> module<a class="headerlink" href="#the-predefined-natural-module" title="Link to this heading">#</a></h2>
<p id="index-0">To calculate the maximum depth of a file, we will need to calculate the depth of
its ancestors, select the maximum depth among them, and increment by 1. Since
the depth of the file system is always a positive integer number, we can encode
it as a natural number. Alloy provides a predefined library
<code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">util</span><span class="o">/</span><span class="n">natural</span></code> that provides a codification of natural numbers in plain
Alloy, and allows us to refrain from using the built-in type <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="kt">Int</span></code>. To
use this library, we need only to import it at the beginning of the Alloy model,
as follows.</p>
<div class="highlight-electrum notranslate"><div class="highlight"><pre><span></span><span class="kn">open</span> <span class="nn">util</span><span class="o">/</span><span class="n">natural</span>
</pre></div>
</div>
<p>This module introduces a signature <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">Natural</span></code> with two distinguished
singleton signatures, <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">Zero</span></code> and <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">One</span></code>. You can inspect all
functions and predicates provided for <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">Natural</span></code> by opening
<code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">util</span><span class="o">/</span><span class="n">natural</span></code> in the menu <span class="menuselection">File ‣ Open Sample
Models…</span>. These include functions <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">inc</span><span class="o">[</span><span class="n">n</span><span class="p">:</span> <span class="n">Natural</span><span class="o">]</span></code> and <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">dec</span><span class="o">[</span><span class="n">n</span><span class="p">:</span>
<span class="n">Natural</span><span class="o">]</span></code> to increment and decrement a natural by 1, respectively, and
arithmetic operations such as <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">add</span><span class="o">[</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">:</span> <span class="n">Natural</span><span class="o">]</span></code> and <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">sub</span><span class="o">[</span><span class="n">n1</span><span class="p">,</span>
<span class="n">n2</span><span class="p">:</span> <span class="n">Natural</span><span class="o">]</span></code>, for addition and subtraction, respectively. A total order is also
imposed over <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">Natural</span></code> using the predefined Alloy module <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">ordering</span></code>,
which introduces function such as <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">max</span><span class="o">[</span><span class="n">ns</span><span class="p">:</span> <span class="k">set</span> <span class="n">Natural</span><span class="o">]</span></code> and
<code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">min</span><span class="o">[</span><span class="n">ns</span><span class="p">:</span> <span class="k">set</span> <span class="n">Natural</span><span class="o">]</span></code>, and predicates such as <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">gt</span><span class="o">[</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">:</span> <span class="n">Natural</span><span class="o">]</span></code>
and <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">lt</span><span class="o">[</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">:</span> <span class="n">Natural</span><span class="o">]</span></code>.</p>
<p>Note that by encoding naturals as a signature, they are bounded by the scope
specified for signature <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">Natural</span></code>. For instance, if you increment a
natural beyond those allowed by the scope, it will just yield an empty set
(without any kind of error or warning). Luckily, in this example it is easy to
identify the maximum natural number needed, since we cannot have a file depth
larger than maximum number of <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">Object</span></code> atoms specified in the scope.</p>
</section>
<section id="recursive-alloy-functions">
<h2>Recursive Alloy functions<a class="headerlink" href="#recursive-alloy-functions" title="Link to this heading">#</a></h2>
<p id="index-1">Let us try to calculate the depth of the file system with the most obvious
strategy: a recursive Alloy function. Although not a particularly simple
function, it is possible to define it in Alloy. One possibility is to define it
as follows.</p>
<div class="highlight-electrum notranslate"><div class="highlight"><pre><span></span><span class="k">fun</span> <span class="nf">depth</span> <span class="o">[</span><span class="n">o</span><span class="p">:</span> <span class="n">Object</span><span class="o">]</span> <span class="p">:</span> <span class="n">Natural</span> <span class="o">{</span>
    <span class="n">o</span> <span class="ow">in</span> <span class="n">Root</span> <span class="ow">implies</span> <span class="n">Zero</span>
    <span class="k">else</span> <span class="n">inc</span><span class="o">[</span><span class="n">max</span><span class="o">[{</span><span class="n">n</span> <span class="p">:</span> <span class="n">Natural</span> <span class="o">|</span> <span class="k">some</span> <span class="n">x</span> <span class="p">:</span> <span class="n">entries</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">o</span> <span class="o">|</span> <span class="n">n</span> <span class="o">=</span> <span class="n">depth</span><span class="o">[</span><span class="n">x</span><span class="o">]}]]</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Given an object, if it is the root then return 0; else, calculate all naturals
that correspond to the depth of the directories that contain that object, select
the maximum and increment it by 1. The tricky part here is calculating the set
of depths of all the ancestors of an object. We’ve defined it by comprehension
by collecting all naturals for which there is any directory containing the file
that depth.</p>
<p>We can now use this function to define a <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="k">run</span></code> command that generates a
file system with a file at a certain depth. For instance, for depth 2, we could
execute the following command.</p>
<div class="highlight-electrum notranslate"><div class="highlight"><pre><span></span><span class="k">run</span> <span class="n">depth2</span> <span class="o">{</span>
    <span class="k">some</span> <span class="n">f</span><span class="p">:</span><span class="n">File</span> <span class="o">|</span> <span class="n">depth</span><span class="o">[</span><span class="n">f</span><span class="o">]</span> <span class="o">=</span> <span class="n">inc</span><span class="o">[</span><span class="n">One</span><span class="o">]</span>
<span class="o">}</span> <span class="k">for</span> <span class="mi">5</span> <span class="k">but</span> <span class="mi">3</span> <span class="n">Name</span>
</pre></div>
</div>
<p id="index-2">The scope of 5 applies to both <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">Object</span></code> and <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">Natural</span></code>, so the
bound on naturals is enough to encode all possible file depths. However, you’ll
actually get the following error from the Analyzer: <em>fun this/depth cannot call
itself recursively!</em> The fact is, the Analyzer’s procedures, based on SAT
solving, cannot handle recursive definitions. Any recursive call to a function
would have to be explicitly unrolled, but it is not possible to know how many
unrolls would be needed in each case. Nonetheless, Alloy does support recursive
function definitions, but in a very restrictive manner since we have to impose a
bound on the number of function unrolls. This feature is disabled by default,
and must be turned on the options, and is limited to a maximum of 3 unrolls due
to performance issues. So, if we follow the menu option <span class="menuselection">Options
‣ Recursion depth</span> and set it to <span class="menuselection">2</span> rather than
<span class="menuselection">disabled</span>, and then run the command again, we will finally
obtain the following instance.</p>
<a class="reference internal image-reference" href="../../../../_images/instance124.png"><img alt="../../../../_images/instance124.png" class="align-center" src="../../../../_images/instance124.png" style="width: 500px;" /></a>
<p>Now, let us try instead to find a file system with depth 3 with the following command.</p>
<div class="highlight-electrum notranslate"><div class="highlight"><pre><span></span><span class="k">run</span> <span class="n">depth3</span> <span class="o">{</span>
    <span class="n">depth</span><span class="o">[</span><span class="n">Root</span><span class="o">]</span> <span class="o">=</span> <span class="n">inc</span><span class="o">[</span><span class="n">inc</span><span class="o">[</span><span class="n">One</span><span class="o">]]</span>
<span class="o">}</span> <span class="k">for</span> <span class="mi">5</span> <span class="k">but</span> <span class="mi">3</span> <span class="n">Name</span>
</pre></div>
</div>
<p>Perhaps unsurprisingly, there is no such instance. That is because with a
recursion depth of 2, it is not possible for <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">depth</span></code> to ever calculate
value 3 (it actually just returns <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="kc">none</span></code> in those cases). If we set menu
option <span class="menuselection">Options ‣ Recursion depth</span> to 3, we will now get the
following instance.</p>
<a class="reference internal image-reference" href="../../../../_images/instance212.png"><img alt="../../../../_images/instance212.png" class="align-center" src="../../../../_images/instance212.png" style="width: 500px;" /></a>
<p>It’s evident that this approach can easily lead to unpredictable results. The
outcome of a command is dependent on an Analyzer option, which in general is a
bad practice in Alloy where models are expected to be self-contained. When the
maximum recursion depth allowed is exceeded, it just “fails silently” by
returning an empty relation. Moreover, the maximum recursion depth allowed by
the Analyzer is just 3, so we will never be able to calculate a file
<code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">depth</span></code> of 4 with this approach. Luckily, we can use a specification
pattern that allows us to circumvent these issues altogether. It is very rare
that recursive functions are useful in Alloy, so let’s just keep
<span class="menuselection">Options ‣ Recursion depth</span> as <span class="menuselection">disabled</span>.</p>
</section>
<section id="recursion-through-memoization">
<h2>Recursion through memoization<a class="headerlink" href="#recursion-through-memoization" title="Link to this heading">#</a></h2>
<p>The alternative approach follows a strategy that resembles <em>memoization</em>: we
introduce a new field in the signature that is to be recursively traversed, and
store in this field the local result of the recursive call. Then, we
declaratively declare the value of this field for all atoms using only the
fields of its ancestors, avoiding recursion calls. There is, of course, a
trade-off: now the recursive result will be computed for all atoms of the
signature, and not only when called in a function.</p>
<p>In our example, we start by introducing a field to represent the depth of each
object, as follows.</p>
<div class="highlight-electrum notranslate"><div class="highlight"><pre><span></span><span class="k">abstract</span> <span class="kd">sig</span> <span class="nc">Object</span> <span class="o">{</span>
    <span class="n">depth</span> <span class="p">:</span> <span class="k">one</span> <span class="n">Natural</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Next, we have to restrict the value of this field to the correct depth. This can
be done declaratively through the following fact.</p>
<div class="highlight-electrum notranslate"><div class="highlight"><pre><span></span><span class="k">fact</span> <span class="nf">calculate_depth</span> <span class="o">{</span>
  <span class="k">all</span> <span class="n">o</span><span class="p">:</span><span class="n">Object</span> <span class="o">|</span>
      <span class="n">o</span> <span class="ow">in</span> <span class="n">Root</span> <span class="ow">implies</span> <span class="n">o</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="n">Zero</span>
      <span class="k">else</span> <span class="n">o</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="n">inc</span><span class="o">[</span><span class="n">max</span><span class="o">[</span><span class="n">entries</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">depth</span><span class="o">]]]</span>
<span class="o">}</span>
</pre></div>
</div>
<p>This fact defines the depth of each object <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">o</span></code> as follows: if <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">o</span></code> is
the root, it has depth 0; else it collects all the depths of the ancestors of
<code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">o</span></code>, selects the maximum, and increments it by 1. Notice that we no longer
need a relation by comprehension to collect the depths of the contents, since
they are already stored in a field.</p>
<p>The <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="k">run</span></code> commands above could be executed exactly as they are due to the
dual syntax of dot join and box join. However, let us re-encode using dot join
to make it clear that <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">depth</span></code> is now a field.</p>
<div class="highlight-electrum notranslate"><div class="highlight"><pre><span></span><span class="k">run</span> <span class="n">depth2</span> <span class="o">{</span>
  <span class="k">some</span> <span class="n">f</span><span class="p">:</span><span class="n">File</span> <span class="o">|</span> <span class="n">f</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="n">inc</span><span class="o">[</span><span class="n">One</span><span class="o">]</span>
<span class="o">}</span> <span class="k">for</span> <span class="mi">5</span> <span class="k">but</span> <span class="mi">3</span> <span class="n">Name</span>
</pre></div>
</div>
<p>After a few theme customizations (showing <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">depth</span></code> as an attribute rather
than an edge, hiding <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">Natural</span></code> atoms, and removing the namespace from
their labels), we obtain instances such as the following.</p>
<a class="reference internal image-reference" href="../../../../_images/instance36.png"><img alt="../../../../_images/instance36.png" class="align-center" src="../../../../_images/instance36.png" style="width: 500px;" /></a>
<p>We can now ask for file systems with a depth as big as that supported by the
scope on naturals. For instance, the following command still generates
instances, and example shown below.</p>
<div class="highlight-electrum notranslate"><div class="highlight"><pre><span></span><span class="k">run</span> <span class="n">depth4</span> <span class="o">{</span>
    <span class="k">some</span> <span class="n">f</span><span class="p">:</span><span class="n">File</span> <span class="o">|</span> <span class="n">f</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="n">inc</span><span class="o">[</span><span class="n">inc</span><span class="o">[</span><span class="n">inc</span><span class="o">[</span><span class="n">One</span><span class="o">]]]</span>
<span class="o">}</span> <span class="k">for</span> <span class="mi">5</span> <span class="k">but</span> <span class="mi">3</span> <span class="n">Name</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../../../../_images/instance42.png"><img alt="../../../../_images/instance42.png" class="align-center" src="../../../../_images/instance42.png" style="width: 500px;" /></a>
<p>Beyond depth 4, with the current scope it is not possible to generate instances,
since there are obviously not enough objects. But even if we increase the scope
on objects and entries, it will not be possible to generate instances since the
natural 5 requires a scope of 6 on <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">Natural</span></code> (natural 0 is also an atom).
So be careful to always update the scope of <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">Natural</span></code> as needed.</p>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="../integers/index.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Working with integers</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="../modules/index.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Module system</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2021-2024, Alcino Cunha, Nuno Macedo, Julien Brunel, David Chemouil
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Handling recursion</a><ul>
<li><a class="reference internal" href="#the-predefined-natural-module">The predefined <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">natural</span></code> module</a></li>
<li><a class="reference internal" href="#recursive-alloy-functions">Recursive Alloy functions</a></li>
<li><a class="reference internal" href="#recursion-through-memoization">Recursion through memoization</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../../../../_static/documentation_options.js?v=10f1778b"></script>
    <script src="../../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../_static/scripts/furo.js?v=32e29ea5"></script>
    <script src="../../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../../../_static/design-tabs.js?v=36754332"></script>
    </body>
</html>