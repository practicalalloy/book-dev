<!doctype html>
<html class="no-js" lang="en" data-content_root="../../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" /><link rel="next" title="Behavioral quick reads" href="../behavioral-topics/index.html" /><link rel="prev" title="Structural analysis" href="../structural-topics/topics/analysis/index.html" />

    <!-- Generated with Sphinx 7.2.6 and Furo 2024.01.29 -->
        <title>Behavioral modeling - Practical Alloy</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=135e06be" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=36a5483c" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  --color-brand-primary: #2a5adf;
  --color-brand-content: #2a5adf;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">Practical Alloy</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  
  
  <span class="sidebar-brand-text">Practical Alloy</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Preface</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../about-alloy/index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../about-book/index.html">About this book</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">The Basics</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../structural-modeling/index.html">Structural modeling</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../structural-topics/index.html">Structural quick reads</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Structural quick reads</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../structural-topics/topics/subset-signatures/index.html">Subset signatures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../structural-topics/topics/nary-relations/index.html">Higher-arity relations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../structural-topics/topics/enumerations/index.html">Enumeration signatures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../structural-topics/topics/commands/index.html">Commands in detail</a></li>
<li class="toctree-l2"><a class="reference internal" href="../structural-topics/topics/themes/index.html">Visualization customization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../structural-topics/topics/evaluator/index.html">The instance evaluator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../structural-topics/topics/testing-instances/index.html">Encoding test instances</a></li>
<li class="toctree-l2"><a class="reference internal" href="../structural-topics/topics/relational-logic/index.html">A relational logic primer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../structural-topics/topics/bestiary/index.html">Arrow multiplicity checks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../structural-topics/topics/ordering/index.html">The predefined <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">ordering</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../structural-topics/topics/modules/index.html">Module system</a></li>
<li class="toctree-l2"><a class="reference internal" href="../structural-topics/topics/recursion/index.html">Handling recursion</a></li>
<li class="toctree-l2"><a class="reference internal" href="../structural-topics/topics/integers/index.html">Working with integers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../structural-topics/topics/type-system/index.html">Type system</a></li>
<li class="toctree-l2"><a class="reference internal" href="../structural-topics/topics/analysis/index.html">Structural analysis</a></li>
</ul>
</li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">Behavioral modeling</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../behavioral-topics/index.html">Behavioral quick reads</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Behavioral quick reads</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../behavioral-topics/topics/mutable-toplevel-signatures/index.html">Mutable top-level signatures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../behavioral-topics/topics/event-depiction/index.html">An idiom for event depiction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../behavioral-topics/topics/scenarios/index.html">Encoding trace scenarios</a></li>
<li class="toctree-l2"><a class="reference internal" href="../behavioral-topics/topics/evaluator/index.html">The trace evaluator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../behavioral-topics/topics/temporal-logic/index.html">A temporal logic primer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../behavioral-topics/topics/pointwise-effects/index.html">Pointwise effects</a></li>
<li class="toctree-l2"><a class="reference internal" href="../behavioral-topics/topics/fairness/index.html">Safety, Liveness and Fairness</a></li>
<li class="toctree-l2"><a class="reference internal" href="../behavioral-topics/topics/sequences/index.html">Sequences</a></li>
<li class="toctree-l2"><a class="reference internal" href="../behavioral-topics/topics/macros/index.html">Macros</a></li>
<li class="toctree-l2"><a class="reference internal" href="../behavioral-topics/topics/meta/index.html">Meta-capabilities</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Applications</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../protocol-design/index.html">Protocol design</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Resources</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../bibliography.html">Bibliography</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../genindex.html">Index</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="behavioral-modeling">
<span id="id1"></span><h1>Behavioral modeling<a class="headerlink" href="#behavioral-modeling" title="Link to this heading">#</a></h1>
<p>In this second chapter we will explain the basics of behavioral modeling with Alloy. As running example we will explore the design of a simple file sharing web application, where a user can upload files making them available for others to download, provided that they have access to a unique single-use token that was associated with shared files. Moreover, uploaded files can be deleted, but the user can for a while undo this action: deleted files are moved to a trash bin from where they can be restored. Upon explicit user request or after a certain period of time, the trash bin is automatically emptied, making all files in it no longer available.</p>
<p>More specifically, in this chapter we will show how Alloy can be used in
the following design tasks:</p>
<ol class="arabic simple">
<li><p>Formally specify, at a very abstract level, the
structure and behavior of this web app.</p></li>
<li><p>Validate this specification by simulation, namely using the
Alloy Analyzer to check that it allows some of the
expected behaviors.</p></li>
<li><p>Verify that this specification entails some of the expected properties of our design.</p></li>
</ol>
<section id="specifying-transition-systems">
<h2>Specifying transition systems<a class="headerlink" href="#specifying-transition-systems" title="Link to this heading">#</a></h2>
<p id="index-0"><em>Transition systems</em> are one of the most standard formalisms to reason
about the behavior of a software system. A transition system contains the different <em>states</em>
a system may be in while evolving over time, identifying which of
these are possible <em>initial states</em>, and clearly depicting how the
system can evolve by identifying the <em>transitions</em> that connect each
state to every possible succeeding state.</p>
<p id="index-1">The first step when specifying a transition system is to describe the
structure of its states. As we have seen in chapter <a class="reference internal" href="../structural-modeling/index.html#structural-modeling"><span class="std std-ref">Structural modeling</span></a>, in Alloy the structure of a system is
described using signatures and fields, all represented by mathematical relations.
By default, in Alloy the value of all signatures and fields is
immutable. To declare a <em>mutable</em> (or <em>variable</em>) signature or field it is necessary to add the
<code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="k">var</span></code> keyword before the respective declaration.</p>
<p>The state of our file sharing web app will be described using the following mutable structures: the set of files currently <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">uploaded</span></code> to the app, the set of items currently <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">trashed</span></code>, and a binary relation that associates <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">shared</span></code> files with the respective access tokens. We start
by declaring two immutable signatures to denote the universe of atoms available throughout the complete trace: <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">File</span></code> for the set of available files, and <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">Token</span></code> for the set of available tokens.
The, relation <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">shared</span></code> is declared as a variable field inside the <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">File</span></code> signature, associating each file with a set of <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">Token</span></code> at each moment. The set of <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">uploaded</span></code> files can be declared as a mutable subset of signature <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">File</span></code> (the set of all possible files), and <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">trashed</span></code> as a mutable subset of <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">uploaded</span></code>.</p>
<div class="highlight-electrum notranslate"><div class="highlight"><pre><span></span><span class="kd">sig</span> <span class="nc">Token</span> <span class="o">{}</span>
<span class="kd">sig</span> <span class="nc">File</span> <span class="o">{</span>
  <span class="k">var</span> <span class="n">shared</span> <span class="p">:</span> <span class="k">set</span> <span class="n">Token</span>
<span class="o">}</span>
<span class="k">var</span> <span class="kd">sig</span> <span class="nc">uploaded</span> <span class="k">in</span> <span class="nc">File</span> <span class="o">{}</span>
<span class="k">var</span> <span class="kd">sig</span> <span class="nc">trashed</span> <span class="k">in</span> <span class="nc">uploaded</span> <span class="o">{}</span>
</pre></div>
</div>
<p id="index-2">Having described the state of our system we can now proceed to
specify its intended behavior, namely what are the initial states and
the possible transitions. Unlike most state-based formal methods, Alloy has no special syntax to
declare the initial states or events that originate transitions. Instead it follows the idea,
introduced by Leslie Lamport in the <em>Temporal Logic of Actions</em> <a class="reference internal" href="../../bibliography.html#toplas94" id="id2"><span>[TOPLAS94]</span></a>, of specifying a
transition system implicitly by means of a <em>temporal logic</em> formula
that dictates which are its valid behaviors. In temporal logic we have operators that can be used to specify how mutable structures evolve over time. Temporal logics differ on how they define what exactly is a behavior of a system. Alloy supports a <em>linear time</em> temporal logic, where a behavior of a system is a <em>trace</em>, an
infinite sequence of states fully describing a possible path in the respective transition system. The most well-known operators of linear time temporal logic, also supported by Alloy, are <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="ow">always</span></code>, that forces the enclosed formula to be valid in all future states, and <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="ow">eventually</span></code>, that forces the enclosed formula to be valid in some future state.</p>
<p>The temporal logic specification of the behavior of our file sharing app should allow the following traces, all examples of valid behaviors in the underlying transition system.</p>
<a class="reference internal image-reference" href="../../_images/valid.png"><img alt="../../_images/valid.png" class="align-center" src="../../_images/valid.png" style="width: 550px;" /></a>
<p>On the other hand, the specification should not allow the following traces, because they do not represent valid behaviors. The invalid initial states and
transitions are identified in red.</p>
<a class="reference internal image-reference" href="../../_images/invalid.png"><img alt="../../_images/invalid.png" class="align-center" src="../../_images/invalid.png" style="width: 550px;" /></a>
<p>In the first trace we have an invalid initial state where there exist already uploaded files, and a transition where simultaneously an file is restored and another file is deleted. In the second trace we have two invalid transitions: in the first we have a simultaneous upload and delete, and in the second we have a file that is no longer uploaded without being first put in the trash bin with a deletion. In the third trace we also have two invalid transitions: in the first we have two files that are simultaneously deleted, and in the second a transition where the trash bin is not fully emptied. Some readers might argue that these two transitions are not problematic and could be allowed. In our specification they will be ruled out, but indeed it is perfectly reasonable to conceive a file sharing app where they are possible. One of the goals of the design phase is precisely to explore such alternative behaviors and choose the one that better fits our goals.</p>
<p id="index-3">The formula specifying a transition system can typically be divided in two
parts: one formula that specifies what are the valid initial states,
and another that specifies how the system can evolve from those initial states. In the initial state of our app no files are uploaded (and, consequently, no files are trashed) and no files have access tokens assigned.
If a formula inside a fact contains no
temporal operators, namely if it is a normal relational logic formula, similar to the ones we have specified in the <a class="reference internal" href="../structural-modeling/index.html#structural-modeling"><span class="std std-ref">Structural modeling</span></a> chapter,
then the fact is only required to hold in the initial state of every trace. Formulas without temporal operators can thus be used to specify the valid initial states.
In our example, the initial states must obey the
following fact. Note that <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">init</span></code> is just the label assigned to the fact, not a special keyword for facts constraining the initial states.</p>
<div class="highlight-electrum notranslate"><div class="highlight"><pre><span></span><span class="k">fact</span> <span class="nf">init</span> <span class="o">{</span>
  <span class="c1">// Initially there are no files uploaded nor shared</span>
  <span class="k">no</span> <span class="n">uploaded</span>
  <span class="k">no</span> <span class="n">shared</span>
<span class="o">}</span>
</pre></div>
</div>
<p id="index-4">To specify the valid transitions, it is easier to specify separately each of the possible
<em>actions</em> (or <em>events</em>) in our system. Each action will originate different transitions when executed in different states. In
the case of the file sharing app we have six actions: <em>upload</em> a file, <em>delete</em> a file, <em>restore</em>
a file, <em>empty</em> the trash, <em>share</em> a file with a token, and <em>download</em> the file associated with a token.
Each action will be specified in separate (parametrized) <em>predicate</em> that holds in a particular state of a trace iff that action can
occur in that state and the next state of the trace is a valid outcome
of the action. As we have already seen in the <a class="reference internal" href="../structural-modeling/index.html#structural-modeling"><span class="std std-ref">Structural modeling</span></a> chapter, a predicate
is a named formula that is only required to hold when invoked.
For example, in our specification we will have a predicate <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">upload</span></code> with a file parameter, and the call <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">upload</span><span class="o">[</span><span class="n">f</span><span class="o">]</span></code> will be will be true in a state iff file <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">f</span></code> is uploaded in that state.</p>
<p id="index-5">Assuming we have specified our six actions in the respective predicates (addressed in the next section), we can constrain the valid
transitions of the system by imposing a fact that requires one of the action predicates to
hold at each
possible state during the system evolution. To impose a constraint on all the states of a trace, we can use
the temporal operator <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="ow">always</span></code> followed by the desired formula.
With this operator we can easily specify the valid transitions of our
system with the following temporal logic formula, where all the action predicates are invoked.</p>
<div class="highlight-electrum notranslate"><div class="highlight"><pre><span></span><span class="k">fact</span> <span class="nf">transitions</span> <span class="o">{</span>
  <span class="c1">// The system must only evolve according to the defined actions</span>
  <span class="ow">always</span> <span class="o">(</span>
    <span class="o">(</span><span class="k">some</span> <span class="n">f</span> <span class="p">:</span> <span class="n">File</span> <span class="o">|</span> <span class="n">upload</span><span class="o">[</span><span class="n">f</span><span class="o">]</span> <span class="ow">or</span> <span class="n">delete</span><span class="o">[</span><span class="n">f</span><span class="o">]</span> <span class="ow">or</span> <span class="n">restore</span><span class="o">[</span><span class="n">f</span><span class="o">])</span> <span class="ow">or</span>
    <span class="o">(</span><span class="k">some</span> <span class="n">f</span> <span class="p">:</span> <span class="n">File</span><span class="p">,</span> <span class="n">t</span> <span class="p">:</span> <span class="n">Token</span> <span class="o">|</span> <span class="n">share</span><span class="o">[</span><span class="n">f</span><span class="p">,</span><span class="n">t</span><span class="o">])</span> <span class="ow">or</span>
    <span class="o">(</span><span class="k">some</span> <span class="n">t</span> <span class="p">:</span> <span class="n">Token</span> <span class="o">|</span> <span class="n">download</span><span class="o">[</span><span class="n">t</span><span class="o">])</span> <span class="ow">or</span>
    <span class="n">empty</span>
  <span class="o">)</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Note the usage of <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="ow">or</span></code> to allow any possible action predicate to hold in each state and the usage of the existential quantifier <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="k">some</span></code> to non-deterministically choose which file and / or token each action acts on. Also note that the parenthesis after the <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="ow">always</span></code> are required because this is a unary operator with higher precedence than any binary operator. When a predicate have no parameters, the brackets can be omitted when calling it, as is the case of <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">empty</span></code>.</p>
</section>
<section id="specifying-actions">
<h2>Specifying actions<a class="headerlink" href="#specifying-actions" title="Link to this heading">#</a></h2>
<p id="index-6">As mentioned above actions are typically specified in predicates that relate pairs of consecutive states. An action predicate checks if the action can occur in a state and if the next state is one of its valid outcomes (or outcome if the action is deterministic).
These two conditions are usually called the <em>guard</em> and
the <em>effect</em> of the action, respectively. To specify the <em>effect</em> we
need to somehow evaluate a formula in the next state or
refer to the value of sets and relations in the next state. To
evaluate a formula in the next state we precede it with the temporal
operator <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="ow">after</span></code>. To evaluate an expression in the next state we
append it the <em>prime</em> operator <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="o">&#39;</span></code>.</p>
<p>For example, the parameterless
<code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">empty</span></code> action predicate can be specified by the conjunction of four formulas as follows.</p>
<div class="highlight-electrum notranslate"><div class="highlight"><pre><span></span><span class="k">pred</span> <span class="nf">empty</span> <span class="o">{</span>
  <span class="k">some</span> <span class="n">trashed</span>                     <span class="c1">// guard</span>
  <span class="k">no</span> <span class="n">trashed</span><span class="o">&#39;</span>                      <span class="c1">// effect on trashed</span>
  <span class="n">uploaded</span><span class="o">&#39;</span> <span class="o">=</span> <span class="n">uploaded</span> <span class="o">-</span> <span class="n">trashed</span>   <span class="c1">// effect on uploaded</span>
  <span class="n">shared</span><span class="o">&#39;</span> <span class="o">=</span> <span class="n">shared</span>                 <span class="c1">// no effect on shared</span>
<span class="o">}</span>
</pre></div>
</div>
<p id="index-7">The first formula is the guard of the action, and it states that the trash
can only be emptied in a state if the set <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">trashed</span></code> contains some files.
After the guard we have three formulas to specify its effect. When specifying
an action we should consider what is its effect on all mutable sets and
fields that comprise the state. If nothing is specified about a particular
mutable relation, then there will be restriction on how
that relation can evolve, meaning that it can change freely when the
action occurs. If the intention was for that set or relation to remain
unchanged when the action occurs, then an explicit formula stating that the
value in the next state is the same as the present value must be added. Such
“no effect” formulas are usually called <em>frame conditions</em>. In the
case of the <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">empty</span></code> predicate, the first effect formula states that in the
next state the <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">trashed</span></code> set will be empty (which could alternatively be
specified by <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="ow">after</span> <span class="k">no</span> <span class="n">trashed</span></code>), the second effect states that in the next state the currently <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">trashed</span></code> files will be removed from <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">uploaded</span></code>, and the last effect
is a frame condition stating that <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">shared</span></code> should remain unchanged.</p>
<p>The <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">upload</span></code> action predicate can be specified as follows, parametrized by the file to be uploaded. Its guard states that the file cannot already be uploaded, and the effect is to add the file to the <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">uploaded</span></code> set.</p>
<div class="highlight-electrum notranslate"><div class="highlight"><pre><span></span><span class="k">pred</span> <span class="nf">upload</span> <span class="o">[</span><span class="n">f</span> <span class="p">:</span> <span class="n">File</span><span class="o">]</span> <span class="o">{</span>
  <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">uploaded</span>          <span class="c1">// guard</span>
  <span class="n">uploaded</span><span class="o">&#39;</span> <span class="o">=</span> <span class="n">uploaded</span> <span class="o">+</span> <span class="n">f</span>   <span class="c1">// effect on uploaded</span>
  <span class="n">trashed</span><span class="o">&#39;</span> <span class="o">=</span> <span class="n">trashed</span>         <span class="c1">// no effect on trashed</span>
  <span class="n">shared</span><span class="o">&#39;</span> <span class="o">=</span> <span class="n">shared</span>           <span class="c1">// no effect on shared</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Recall that in Alloy every expression denotes a relation, and in particular a variable denotes a singleton set containing a unary tuple with the respective value. So the <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">f</span></code> in <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">uploaded</span> <span class="o">+</span> <span class="n">f</span></code> is a set of files,
just like <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">uploaded</span></code> itself, and it is possible to compute the union of
both. This may seem rather strange at first, but it is one of the
nice details of Alloy, that further contributes to simplify its
semantics and syntax. In particular, the set union operator can also be used for adding an element to a set. Another example is the <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="ow">in</span></code>
operator which tests for set inclusion. Again, since <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">f</span></code> denotes a
singleton set, the expression <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">uploaded</span></code> is checking
whether <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">f</span></code> is currently not a member of <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">uploaded</span></code>, without the need for a specific membership test operator.</p>
<p>Action predicates <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">delete</span></code> and <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">restore</span></code> can be specified as follows.</p>
<div class="highlight-electrum notranslate"><div class="highlight"><pre><span></span><span class="k">pred</span> <span class="nf">delete</span> <span class="o">[</span><span class="n">f</span> <span class="p">:</span> <span class="n">File</span><span class="o">]</span> <span class="o">{</span>
  <span class="n">f</span> <span class="ow">in</span> <span class="n">uploaded</span> <span class="o">-</span> <span class="n">trashed</span>       <span class="c1">// guard</span>
  <span class="n">trashed</span><span class="o">&#39;</span> <span class="o">=</span> <span class="n">trashed</span> <span class="o">+</span> <span class="n">f</span>        <span class="c1">// effect on trashed</span>
  <span class="n">shared</span><span class="o">&#39;</span> <span class="o">=</span> <span class="n">shared</span> <span class="o">-</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">Token</span>   <span class="c1">// effect on shared</span>
  <span class="n">uploaded</span><span class="o">&#39;</span> <span class="o">=</span> <span class="n">uploaded</span>          <span class="c1">// no effect on uploaded</span>
<span class="o">}</span>

<span class="k">pred</span> <span class="nf">restore</span> <span class="o">[</span><span class="n">f</span> <span class="p">:</span> <span class="n">File</span><span class="o">]</span> <span class="o">{</span>
  <span class="n">f</span> <span class="ow">in</span> <span class="n">trashed</span>                  <span class="c1">// guard</span>
  <span class="n">trashed</span><span class="o">&#39;</span> <span class="o">=</span> <span class="n">trashed</span> <span class="o">-</span> <span class="n">f</span>        <span class="c1">// effect on trashed</span>
  <span class="n">uploaded</span><span class="o">&#39;</span> <span class="o">=</span> <span class="n">uploaded</span>          <span class="c1">// no effect on uploaded</span>
  <span class="n">shared</span><span class="o">&#39;</span> <span class="o">=</span> <span class="n">shared</span>              <span class="c1">// no effect on shared</span>
<span class="o">}</span>
</pre></div>
</div>
<p>The guard of <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">delete</span></code> states that a file can only be deleted if it is uploaded but not already in the trash. The first effect just states that the file is added to the trash bin. The second effect states that all shared tokens associated with the file should be removed. Recall that <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">shared</span></code> is a binary relation associating files with the respective tokens. Expression <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">f</span><span class="o">-&gt;</span><span class="n">Token</span></code> denotes the cartesian product of the singleton set <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">f</span></code> with <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">Token</span></code>, the set of all possible tokens, so it denotes the set of all pairs <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="o">(</span><span class="n">f</span><span class="p">,</span><span class="n">t</span><span class="o">)</span></code> where <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">t</span></code> is any possible <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">Token</span></code>. By subtracting this set from <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">shared</span></code> we will “disconnecting” file <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">f</span></code> from any possible token it is associated with. Alternatively, we could be more specific and subtract from <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">shared</span></code> only the set of tokens that are associated with the file by using expression <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">f</span><span class="o">-&gt;</span><span class="n">f</span><span class="o">.</span><span class="n">shared</span></code> instead of <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">f</span><span class="o">-&gt;</span><span class="n">Token</span></code>.
The last effect on <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">delete</span></code> is a frame condition stating that <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">uploaded</span></code> does not change. Action <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">restore</span></code> is simpler to specify, just removing the parameter file from the trash bin.</p>
<p id="index-8">The <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">share</span></code> action predicate will assigned to a file a fresh token. The guard will require that the token to be associated with a file has never been used before. This is required, because otherwise users could later try to download unauthorized files using a token that was shared with them before.
Although action predicates typically compare only the current state with the
succeeding state, they can actually refer to other states of the trace using
temporal operators. This is particularly useful when the guard of an event depends on the execution history: while in a concrete implementation this will probably require additional structure to log previously used tokens, in Alloy we can just specify such a guard declaratively.
So, to specify the fresh token guard of <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">share</span></code>: we will resort to the temporal operator <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="ow">historically</span></code>, a past temporal operator that can be used to check if a formula was always true in the past (up to, and including the current state).</p>
<div class="highlight-electrum notranslate"><div class="highlight"><pre><span></span><span class="k">pred</span> <span class="nf">share</span> <span class="o">[</span><span class="n">f</span> <span class="p">:</span> <span class="n">File</span><span class="p">,</span> <span class="n">t</span> <span class="p">:</span> <span class="n">Token</span><span class="o">]</span> <span class="o">{</span>
  <span class="n">f</span> <span class="ow">in</span> <span class="n">uploaded</span> <span class="o">-</span> <span class="n">trashed</span>             <span class="c1">// guard</span>
  <span class="ow">historically</span> <span class="n">t</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">File</span><span class="o">.</span><span class="n">shared</span>   <span class="c1">// guard</span>
  <span class="n">shared</span><span class="o">&#39;</span> <span class="o">=</span> <span class="n">shared</span> <span class="o">+</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">t</span>             <span class="c1">// effect on shared</span>
  <span class="n">uploaded</span><span class="o">&#39;</span> <span class="o">=</span> <span class="n">uploaded</span>                <span class="c1">// no effect on uploaded</span>
  <span class="n">trashed</span><span class="o">&#39;</span> <span class="o">=</span> <span class="n">trashed</span>                  <span class="c1">// no effect on trashed</span>
<span class="o">}</span>
</pre></div>
</div>
<p>The first guard requires that the file is currently not trashed. The second guard uses <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="ow">historically</span></code> to check that the token <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">t</span></code> was never contained in <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">File</span><span class="o">.</span><span class="n">shared</span></code>, the set of tokens associated with any file at a certain state. The effect of this action is to add a new association between <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">f</span></code> and <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">t</span></code> to relation <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">shared</span></code>. Expression <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">f</span><span class="o">-&gt;</span><span class="n">t</span></code> uses the Cartesian product between two singleton sets to define the singleton binary relation containing the pair <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="o">(</span><span class="n">f</span><span class="p">,</span><span class="n">t</span><span class="o">)</span></code>. Using the union operator this pair is then added to <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">shared</span></code>. The remaining formulas are frame conditions stating that <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">share</span></code> has no effect on <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">uploaded</span></code> nor on <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">trashed</span></code>.</p>
<p>Finally, the <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">download</span></code> action is specified as follows. The token must be associated with some file by the <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">shared</span></code> relation, and since we want tokens to be single use, they are removed from the <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">shared</span></code> relation to prevent further downloads.</p>
<div class="highlight-electrum notranslate"><div class="highlight"><pre><span></span><span class="k">pred</span> <span class="nf">download</span> <span class="o">[</span><span class="n">t</span> <span class="p">:</span> <span class="n">Token</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">some</span> <span class="n">shared</span><span class="o">.</span><span class="n">t</span>                <span class="c1">// guard</span>
  <span class="n">shared</span><span class="o">&#39;</span> <span class="o">=</span> <span class="n">shared</span> <span class="o">-</span> <span class="n">File</span><span class="o">-&gt;</span><span class="n">t</span>   <span class="c1">// effect on shared</span>
  <span class="n">uploaded</span><span class="o">&#39;</span> <span class="o">=</span> <span class="n">uploaded</span>         <span class="c1">// no effect on uploaded</span>
  <span class="n">trashed</span><span class="o">&#39;</span> <span class="o">=</span> <span class="n">trashed</span>           <span class="c1">// no effect on trashed</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="sd-sphinx-override sd-cards-carousel sd-card-cols-2 docutils">
<div class="sd-card sd-sphinx-override sd-mb-3 sd-shadow-sm sd-card-hover docutils">
<div class="sd-card-header docutils">
<p class="sd-card-text"><svg version="1.1" width="1.0em" height="1.0em" class="sd-octicon sd-octicon-link" viewBox="0 0 16 16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg> Further reading</p>
</div>
<div class="sd-card-body docutils">
<div class="sd-card-title sd-font-weight-bold docutils">
Frame conditions</div>
<p class="sd-card-text">Learn different techniques to specify effects and frame conditions.</p>
</div>
<span class="sd-stretched-link"></span></div>
<div class="sd-card sd-sphinx-override sd-mb-3 sd-shadow-sm sd-card-hover docutils">
<div class="sd-card-header docutils">
<p class="sd-card-text"><svg version="1.1" width="1.0em" height="1.0em" class="sd-octicon sd-octicon-link" viewBox="0 0 16 16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg> Further reading</p>
</div>
<div class="sd-card-body docutils">
<div class="sd-card-title sd-font-weight-bold docutils">
Mutable top-level signatures</div>
<p class="sd-card-text">It is possible to declare a top-level signature as mutable. Learn how a mutable <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">File</span></code> signature can be used to directly capture the <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">uploaded</span></code> files.</p>
</div>
<a class="sd-stretched-link reference internal" href="../behavioral-topics/topics/mutable-toplevel-signatures/index.html#mutable-toplevel-signatures"><span class="std std-ref"></span></a></div>
</div>
</section>
<section id="stuttering">
<h2>Stuttering<a class="headerlink" href="#stuttering" title="Link to this heading">#</a></h2>
<p>The specification of our file sharing app is not entirely fine. For example, the following trace will not be considered valid.</p>
<a class="reference internal image-reference" href="../../_images/stuttering.png"><img alt="../../_images/stuttering.png" class="align-center" src="../../_images/stuttering.png" style="width: 500px;" /></a>
<p>Here a file was uploaded and for a while nothing happened until the file was trashed. In the transitions where nothing happened the user could, for example, have been interacting with other apps and, obviously, those interactions have no effect on the state of the file sharing app. The global state of the world still evolved, but the portion of that global state that corresponds to our app, and  that is the focus of our specification, did not change.</p>
<p id="index-9">It is recommended that the specification of a system allows such <em>stuttering</em> transitions. From a philosophical point of view they capture actions that can happen in the world outside our system, but they also have a practical use. First, allowing them enables our specification to be later composed with the specification of other systems executing concurrently: without stuttering all systems would be forced to execute synchronously, which can be overly restrictive. In chapter <span class="xref std std-ref">app-design</span> we will see examples of such compositions. Second, allowing <em>stuttering</em> is a simple way to make sure all behaviors can be extended to infinite traces, a requirement in Alloy and in most model checkers (adopter to simplify the semantics of temporal logic operators): in the worst case scenario, if a <em>deadlock</em> is reached where no action can occur, the system could still stutter forever. For example, if you start to validate the specification (more on this in the next section), you’ll soon realize that the only valid traces are those where a <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">restore</span></code> or an <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">empty</span></code> necessarily occur to bring the trace to a previous state. This is because, whatever happens, eventually all tokens would be exhausted and all files will be in the trash, and a deadlock would be reached. Without stuttering none of the possible behaviors could  be extended to an infinite trace, and our specification would be useless.</p>
<p>The specification of a stuttering event is a trivial predicate that consists only of frame conditions.</p>
<div class="highlight-electrum notranslate"><div class="highlight"><pre><span></span><span class="k">pred</span> <span class="nf">stutter</span> <span class="o">{</span>
   <span class="n">uploaded</span><span class="o">&#39;</span> <span class="o">=</span> <span class="n">uploaded</span>    <span class="c1">// no effect on uploaded</span>
   <span class="n">trashed</span><span class="o">&#39;</span> <span class="o">=</span> <span class="n">trashed</span>      <span class="c1">// no effect on trashed</span>
   <span class="n">shared</span><span class="o">&#39;</span> <span class="o">=</span> <span class="n">shared</span>        <span class="c1">// no effect on trashed</span>
<span class="o">}</span>
</pre></div>
</div>
<p>To allow stuttering in our system we need to change the fact that specifies the valid transitions as follows.</p>
<div class="highlight-electrum notranslate"><div class="highlight"><pre><span></span><span class="k">fact</span> <span class="nf">transitions_or_stutter</span> <span class="o">{</span>
   <span class="c1">// The system either evolves according to the defined actions or stutters</span>
   <span class="ow">always</span> <span class="o">(</span>
      <span class="o">(</span><span class="k">some</span> <span class="n">f</span> <span class="p">:</span> <span class="n">File</span> <span class="o">|</span> <span class="n">upload</span><span class="o">[</span><span class="n">f</span><span class="o">]</span> <span class="ow">or</span> <span class="n">delete</span><span class="o">[</span><span class="n">f</span><span class="o">]</span> <span class="ow">or</span> <span class="n">restore</span><span class="o">[</span><span class="n">f</span><span class="o">])</span> <span class="ow">or</span>
      <span class="o">(</span><span class="k">some</span> <span class="n">f</span> <span class="p">:</span> <span class="n">File</span><span class="p">,</span> <span class="n">t</span> <span class="p">:</span> <span class="n">Token</span> <span class="o">|</span> <span class="n">share</span><span class="o">[</span><span class="n">f</span><span class="p">,</span><span class="n">t</span><span class="o">])</span> <span class="ow">or</span>
      <span class="o">(</span><span class="k">some</span> <span class="n">t</span> <span class="p">:</span> <span class="n">Token</span> <span class="o">|</span> <span class="n">download</span><span class="o">[</span><span class="n">t</span><span class="o">])</span> <span class="ow">or</span>
      <span class="n">empty</span> <span class="ow">or</span>
      <span class="n">stutter</span>
   <span class="o">)</span>
<span class="o">}</span>
</pre></div>
</div>
</section>
<section id="validating-the-design">
<h2>Validating the design<a class="headerlink" href="#validating-the-design" title="Link to this heading">#</a></h2>
<p id="index-10">Now that we have a first specification of the intend behavior of the
file sharing app, and before proceeding with the verification of expected properties, it is advisable to perform some validation to get some assurance that indeed it
behaves as expected. A typical way to perform such validation is by
using some sort of user-guided simulation. The Alloy Analyzer has
several mechanisms to allow the user to explore and validate a design,
including an interactive exploration mode akin so simulation <a class="reference internal" href="../../bibliography.html#fide19" id="id3"><span>[FIDE19]</span></a>.</p>
<p id="index-11">Recall that Alloy has two analysis commands: <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="k">run</span></code> commands instruct the Analyzer to
check the satisfiability of the formula (and its consistency with the declared facts),
yielding a satisfying instance if that is the case;  <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="k">check</span></code>
commands instruct the Analyzer to check the validity of a formula
(assuming the declared facts to be true), yielding a counter-example
instance if that is not the case. In the case of specifications with
mutable relations, an instance
is a valid execution trace, an infinite sequence of states, each a
valuation of the declared signatures and fields.</p>
<p>As we have seen in the previous chapter, the usual way to start validating a specification is to define an
empty <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="k">run</span></code> command to ask for any instance that satisfies all the
declared facts. To kick-start the validation process we will add such an
empty command (named <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">example</span></code>) to our model.</p>
<div class="highlight-electrum notranslate"><div class="highlight"><pre><span></span><span class="k">run</span> <span class="n">example</span> <span class="o">{}</span>
</pre></div>
</div>
<p>After executing this command we get the
following instance.</p>
<img alt="../../_images/instance1.png" class="align-center" src="../../_images/instance1.png" />
<p id="index-12">When a specification has mutable relations, the instance visualizer is slightly different from what we have seen in the <a class="reference internal" href="../structural-modeling/index.html#structural-modeling"><span class="std std-ref">Structural modeling</span></a> chapter.
Below the toolbar, the Alloy
visualizer now shows a depiction of the instance trace, which in this case
consists of the initial state repeating itself forever, which is a valid behavior because of stuttering.
All traces returned by the Alloy
Analyzer will have the same shape: a finite sequence of states followed by
a loop back to one of the previous (or the same) states. There can be infinite execution traces
that are not of this shape, but the tool only returns and depicts traces that can be
represented finitely using a back loop.</p>
<div class="admonition-todo admonition" id="id4">
<p class="admonition-title">Todo</p>
<p>nmm: the sentence above is kind of scary without additional context. alcino: maybe its better to remove, as it will probably me mentioned in the temporal logic card.</p>
</div>
<p>In the lower part of the window the visualizer
focuses on a particular transition of the trace, depicting the pre- and
post-state using the default Alloy theme: the atoms are named sequentially according to
the signature they belong to, and atoms belonging to a subset
signature (such as <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">uploaded</span></code>) will be labelled with that signature name.
Mutable sets (and relations) are drawn with dashed borders by default,
but this can be changed in the theme.
In the instance above, there are no such mutable elements, as expected, since fact <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">init</span></code> is forcing all mutable signatures and fields to be empty in the first state.
The two states being
depicted are the ones shown in white in the trace depiction, and will be kept
centered in that depiction. When the visualizer window pops up
the transition being depicted is always the first one, with the
state on the left-hand side being the initial state of the trace.</p>
<p>To navigate in the trace, namely to move forwards and backwards to
focus on a different transition, just press the <span class="guilabel">→</span> or
<span class="guilabel">←</span> buttons in the toolbar (or <kbd class="kbd compound docutils literal notranslate"><kbd class="kbd docutils literal notranslate">cmd</kbd>-<kbd class="kbd docutils literal notranslate">→</kbd></kbd> and <kbd class="kbd compound docutils literal notranslate"><kbd class="kbd docutils literal notranslate">cmd</kbd>-<kbd class="kbd docutils literal notranslate">←</kbd></kbd>), respectively. For example, by moving forward to
focus on the second transition we get the following, which obviously is another stuttering step.</p>
<img alt="../../_images/instance2.png" class="align-center" src="../../_images/instance2.png" />
<p id="index-13">In the toolbar of the Alloy instance visualizer window we can also find
four new buttons, that can be used to ask the Analyzer for alternative
instances:</p>
<p><span class="guilabel">New Config</span></p>
<blockquote>
<div><p>This button, or shortcut <kbd class="kbd compound docutils literal notranslate"><kbd class="kbd docutils literal notranslate">cmd</kbd>-<kbd class="kbd docutils literal notranslate">c</kbd></kbd>, asks for a new trace that differs in the values of immutable sets and relations. Usually, immutable elements constitute the <em>configuration</em> of a system (for example, describing a specific network topology where a protocol is to be executed), and by pressing this button we will get an execution trace with a different configuration. In the case of the file sharing app, the only immutable relations are signatures <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">File</span></code> and <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">Token</span></code>, so pressing this button should give us a trace with a different number of files or a different number of tokens.</p>
</div></blockquote>
<p><span class="guilabel">New Trace</span></p>
<blockquote>
<div><p>This button, or shortcut <kbd class="kbd compound docutils literal notranslate"><kbd class="kbd docutils literal notranslate">cmd</kbd>-<kbd class="kbd docutils literal notranslate">t</kbd></kbd>, asks for a new (different) execution trace with the same configuration.</p>
</div></blockquote>
<p><span class="guilabel">New Init</span></p>
<blockquote>
<div><p>This button, or shortcut <kbd class="kbd compound docutils literal notranslate"><kbd class="kbd docutils literal notranslate">cmd</kbd>-<kbd class="kbd docutils literal notranslate">i</kbd></kbd> asks for a new trace with a different initial value for mutable sets and relations, allowing us to quickly explore a scenario starting with different initial conditions. In our example, for each configuration there is only one possible initial state, so pressing this button will not return any instance.</p>
</div></blockquote>
<p><span class="guilabel">New Fork</span></p>
<blockquote>
<div><p>Finally, this button, or shortcut <kbd class="kbd compound docutils literal notranslate"><kbd class="kbd docutils literal notranslate">cmd</kbd>-<kbd class="kbd docutils literal notranslate">f</kbd></kbd>, asks for a different trace with the same behavior up to the (left-hand) pre-state we are currently focused, but a different transition at this point. If that is possible, the pre-state will remain the same and we will see a different post-state. The latter could be a different result for the same (non-deterministic) event, or the outcome of a different event.</p>
</div></blockquote>
<p>For example, if at this point we press <span class="guilabel">New Config</span> we could get the following trace, where we have two possible tokens but the system still stutters forever.</p>
<img alt="../../_images/instance3.png" class="align-center" src="../../_images/instance3.png" />
<p>If now we press <span class="guilabel">New Trace</span> we may get the following trace.</p>
<img alt="../../_images/instance4.png" class="align-center" src="../../_images/instance4.png" />
<p>In this trace, the first transition is the upload of the only file in the universe, and then the system stutters forever, as can be seen in the trace depiction. Pressing <span class="guilabel">New Trace</span> again could produce the following trace, where the first transition is again a stuttering step.</p>
<img alt="../../_images/instance5.png" class="align-center" src="../../_images/instance5.png" />
<p>To see the second transition, which is the upload of the file, we can press <span class="guilabel">→</span>.</p>
<img alt="../../_images/instance6.png" class="align-center" src="../../_images/instance6.png" />
<p id="index-14">Before proceeding with the validation of our specification, let’s change our visualization theme, for example by setting different colors for files not currently uploaded (white), uploaded files (yellow), and trashed files (red), and different shapes for files (circles) and tokens (rectangles), with the latter also colored gray. Finally, hide the subset labels and change the color palette. After customizing the theme the above transition will be displayed as follows.</p>
<img alt="../../_images/instance7.png" class="align-center" src="../../_images/instance7.png" />
<p>While <span class="guilabel">New Trace</span> allows some quick validation of the specification, <span class="guilabel">New Fork</span> is the main tool used in this task, since it allows us to quickly narrow our exploration to the behaviors of interest, instead of just pressing <span class="guilabel">New Trace</span> until they eventually show up. For example, let us suppose we wanted to see if the following sequence of actions is possible: upload a file, share it with two different tokens, download it with one token, delete it, and finally empty the trash. To search for this scenario, we first re-execute our command, and press <span class="guilabel">New Config</span> to get the desired configuration with one file and two tokens.</p>
<img alt="../../_images/instance8.png" class="align-center" src="../../_images/instance8.png" />
<p>Pressing <span class="guilabel">New Fork</span> will necessarily change the stuttering step to a file upload, because that is the only other action that can occur at this point.</p>
<img alt="../../_images/instance9.png" class="align-center" src="../../_images/instance9.png" />
<p>Pressing <span class="guilabel">→</span> to move to the second transition, which is a stuttering step, and pressing <span class="guilabel">New Fork</span> may produce the following trace, where the uploaded file is trashed and then the trash emptied, moving the system back to the initial state. Notice in the trace depiction how in this infinite trace the last state loops back to a state other than itself.</p>
<img alt="../../_images/instance10.png" class="align-center" src="../../_images/instance10.png" />
<p>Since this is not the behavior we want to explore, we can press <span class="guilabel">New Fork</span> again to change this transition to a sharing action (the only other possible action).</p>
<img alt="../../_images/instance11.png" class="align-center" src="../../_images/instance11.png" />
<p>Pressing <span class="guilabel">→</span> and <span class="guilabel">New Fork</span> may show us the second share action.</p>
<img alt="../../_images/instance12.png" class="align-center" src="../../_images/instance12.png" />
<p>By repeatedly pressing these buttons we can produce the remaining steps of our desired scenario.</p>
<img alt="../../_images/instance13.png" class="align-center" src="../../_images/instance13.png" />
<img alt="../../_images/instance14.png" class="align-center" src="../../_images/instance14.png" />
<img alt="../../_images/instance15.png" class="align-center" src="../../_images/instance15.png" />
<p>We can also use <span class="guilabel">New Fork</span> to check that no unexpected behaviors can happen. For example, at this point the only other possible action should be the following restore action.</p>
<img alt="../../_images/instance16.png" class="align-center" src="../../_images/instance16.png" />
<p>We can confirm this by pressing <span class="guilabel">New Fork</span> and see if the “The are no more satisfying instances” error window appears, which is the case here.</p>
<a class="reference internal image-reference" href="../../_images/nomore.png"><img alt="../../_images/nomore.png" class="align-center" src="../../_images/nomore.png" style="width: 500px;" /></a>
<div class="sd-sphinx-override sd-cards-carousel sd-card-cols-2 docutils">
<div class="sd-card sd-sphinx-override sd-mb-3 sd-shadow-sm sd-card-hover docutils">
<div class="sd-card-header docutils">
<p class="sd-card-text"><svg version="1.1" width="1.0em" height="1.0em" class="sd-octicon sd-octicon-link" viewBox="0 0 16 16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg> Further reading</p>
</div>
<div class="sd-card-body docutils">
<div class="sd-card-title sd-font-weight-bold docutils">
Event depiction</div>
<p class="sd-card-text">Learn a simple Alloy idiom that can be used to depict which events occurred in each transition of a trace.</p>
</div>
<a class="sd-stretched-link reference internal" href="../behavioral-topics/topics/event-depiction/index.html#event-depiction"><span class="std std-ref"></span></a></div>
<div class="sd-card sd-sphinx-override sd-mb-3 sd-shadow-sm sd-card-hover docutils">
<div class="sd-card-header docutils">
<p class="sd-card-text"><svg version="1.1" width="1.0em" height="1.0em" class="sd-octicon sd-octicon-link" viewBox="0 0 16 16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg> Further reading</p>
</div>
<div class="sd-card-body docutils">
<div class="sd-card-title sd-font-weight-bold docutils">
Encoding scenarios</div>
<p class="sd-card-text">Learn how to specify <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="k">run</span></code> commands that directly search for specific scenarios, where a particular sequence of actions occurred, namely the one used in this chapter to perform the validation.</p>
</div>
<a class="sd-stretched-link reference internal" href="../behavioral-topics/topics/scenarios/index.html#scenarios"><span class="std std-ref"></span></a></div>
</div>
</section>
<section id="verifying-expected-properties">
<h2>Verifying expected properties<a class="headerlink" href="#verifying-expected-properties" title="Link to this heading">#</a></h2>
<p id="index-15">After validating the design of our file sharing app we proceed with the specification and verification of some properties that are expected to hold.
A nice thing about Alloy is that the same logic is used to
both specify the system and its expected properties. In many formal
specification languages and verification tools (namely, most model
checkers), a different language is used for each. In Alloy we use
linear temporal logic, of which we already presented some operators, namely the fundamental <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="ow">always</span></code> and <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="ow">eventually</span></code> operators, and also the <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="ow">after</span></code> operator, that requires a formula to be true in the next state (which always exists because traces are infinite).
These are examples of operators that constrain the future behavior in a trace, but in Alloy we also have operators that constrain the past behavior. We already saw one example of the latter, namely the <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="ow">historically</span></code> operator that forces a formula to always be true in the past (including the current state). Alloy has a few more temporal operators. For example, we have <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="ow">once</span></code> that requires a formula to be true sometime in the past (or in the current state), and <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="ow">before</span></code> that requires a formula to be true in the previous state (if evaluated in a initial state it will always be false because there is no previous state). All these are unary operators, but Alloy also has a few binary temporal operators. One of the most useful is <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="ow">releases</span></code>, that enforces the right-hand side formula to only stop being true after the left-hand side formula becomes true.</p>
<p id="index-16">As we have already seen, formulas that we want to verify with <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="k">check</span></code> commands can be written in
assertions. The most frequent (and simple) temporal properties we can specify with temporal logic are <em>invariants</em>, formulas requiring some constraint to be true in all states of all possible behaviors. These can be specified with a single <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="ow">always</span></code> followed by the invariant property. For example, an invariant that should be valid in our app is that all shared files should still be uploaded and not in the trash. This assertion can be specified and checked as follows.</p>
<div class="highlight-electrum notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="nf">shared_are_accessible</span> <span class="o">{</span>
   <span class="ow">always</span> <span class="n">shared</span><span class="o">.</span><span class="n">Token</span> <span class="ow">in</span> <span class="n">uploaded</span> <span class="o">-</span> <span class="n">trashed</span>
<span class="o">}</span>
<span class="k">check</span> <span class="n">shared_are_accessible</span>
</pre></div>
</div>
<p>As expected, the check yields no counter-example. Another expected property could be that a restore undoes a delete action, something we can specify as follows.</p>
<div class="highlight-electrum notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="nf">restore_undos_delete</span> <span class="o">{</span>
   <span class="k">all</span> <span class="n">f</span> <span class="p">:</span> <span class="n">File</span> <span class="o">|</span> <span class="ow">always</span> <span class="o">(</span>
      <span class="n">delete</span><span class="o">[</span><span class="n">f</span><span class="o">]</span> <span class="ow">and</span> <span class="ow">after</span> <span class="n">restore</span><span class="o">[</span><span class="n">f</span><span class="o">]</span> <span class="ow">implies</span>
      <span class="n">uploaded</span><span class="o">&#39;&#39;</span> <span class="o">=</span> <span class="n">uploaded</span> <span class="ow">and</span> <span class="n">trashed</span><span class="o">&#39;&#39;</span> <span class="o">=</span> <span class="n">trashed</span> <span class="ow">and</span> <span class="n">shared</span><span class="o">&#39;&#39;</span> <span class="o">=</span> <span class="n">shared</span>
   <span class="o">)</span>
<span class="o">}</span>
<span class="k">check</span> <span class="n">restore_undos_delete</span>
</pre></div>
</div>
<p>Here we used the <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="ow">after</span></code> operator to check that the <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">restore</span></code> action occurred after the <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">delete</span></code>, and a double prime to evaluate the value of the mutable fields two states ahead and check that that value is same as before executing the <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">delete</span></code>. Checking this assertion will actually yield the following counter-example, where a file has an associated token  which is removed when the file is delete and is not recovered by the restore.</p>
<img alt="../../_images/instance17.png" class="align-center" src="../../_images/instance17.png" />
<img alt="../../_images/instance18.png" class="align-center" src="../../_images/instance18.png" />
<p>If we really wanted this property to hold we could change our design in two ways: either keep the associations between files and tokens when deleting them or forbid the deletion of shared files.
The converse assertion that delete undoes restore does hold in the current specification.</p>
<p>A key property of our app is that tokens are single use. We can check that indeed that is the case, by checking that after downloading a file with a token that token can no longer be used to download another file.</p>
<div class="highlight-electrum notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="nf">one_download_per_token</span> <span class="o">{</span>
   <span class="k">all</span> <span class="n">t</span> <span class="p">:</span> <span class="n">Token</span> <span class="o">|</span> <span class="ow">always</span> <span class="o">(</span>
      <span class="n">download</span><span class="o">[</span><span class="n">t</span><span class="o">]</span> <span class="ow">implies</span>
      <span class="ow">after</span> <span class="ow">always</span> <span class="ow">not</span> <span class="n">download</span><span class="o">[</span><span class="n">t</span><span class="o">]</span>
   <span class="o">)</span>
<span class="o">}</span>
<span class="k">check</span> <span class="n">one_download_per_token</span>
</pre></div>
</div>
<p id="index-17">Notice how here we use two nested <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="ow">always</span></code> operators to say that <em>whenever</em> a token is used, <em>from then</em> on it will not be used again. The inner <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="ow">always</span></code> is coupled with an <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="ow">after</span></code> because it only applies to the states after the download occurs: otherwise we would be forcing <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">download</span><span class="o">[</span><span class="n">t</span><span class="o">]</span></code> and <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="ow">not</span> <span class="n">download</span><span class="o">[</span><span class="n">t</span><span class="o">]</span></code> in the same state.</p>
<p>To make the specification of this assertion more readable we can define a function that returns the set of files that were <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="ow">once</span></code> downloaded with a given token. In Alloy we can use the <em>set comprehension</em> notation to define a set or a relation. As usual, to define a set by comprehension we use a predicate defined over a quantified variable: any atom that satisfies the predicate will be included in the resulting set. The desired function can be defined as follows.</p>
<div class="highlight-electrum notranslate"><div class="highlight"><pre><span></span><span class="k">fun</span> <span class="nf">downloaded</span> <span class="o">[</span><span class="n">t</span> <span class="p">:</span> <span class="n">Token</span><span class="o">]</span> <span class="p">:</span> <span class="k">set</span> <span class="n">File</span> <span class="o">{</span>
   <span class="o">{</span> <span class="n">f</span> <span class="p">:</span> <span class="n">File</span> <span class="o">|</span> <span class="ow">once</span> <span class="o">(</span><span class="n">download</span><span class="o">[</span><span class="n">t</span><span class="o">]</span> <span class="ow">and</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">shared</span><span class="o">)</span> <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Using this function the previous assertion could alternatively be specified as follows.</p>
<div class="highlight-electrum notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="nf">one_download_per_token</span> <span class="o">{</span>
   <span class="k">all</span> <span class="n">t</span> <span class="p">:</span> <span class="n">Token</span> <span class="o">|</span> <span class="ow">always</span> <span class="k">lone</span> <span class="n">downloaded</span><span class="o">[</span><span class="n">t</span><span class="o">]</span>
<span class="o">}</span>
</pre></div>
</div>
<p>To give an example of <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="ow">releases</span></code> consider the following assertion (also valid in our system), stating that after emptying the trash, it can only be emptied again after a file is deleted.</p>
<div class="highlight-electrum notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="nf">empty_after_restore</span> <span class="o">{</span>
   <span class="ow">always</span> <span class="o">(</span>
      <span class="n">empty</span> <span class="ow">implies</span>
      <span class="ow">after</span> <span class="o">((</span><span class="k">some</span> <span class="n">f</span> <span class="p">:</span> <span class="n">File</span> <span class="o">|</span> <span class="n">delete</span><span class="o">[</span><span class="n">f</span><span class="o">])</span> <span class="ow">releases</span> <span class="ow">not</span> <span class="n">empty</span><span class="o">)</span>
   <span class="o">)</span>
<span class="o">}</span>
<span class="k">check</span> <span class="n">empty_after_restore</span>
</pre></div>
</div>
<p>The formula <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="o">(</span><span class="k">some</span> <span class="n">f</span> <span class="p">:</span> <span class="n">File</span> <span class="o">|</span> <span class="n">delete</span><span class="o">[</span><span class="n">f</span><span class="o">])</span> <span class="ow">releases</span> <span class="ow">not</span> <span class="n">empty</span></code> is true in a state iff <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="ow">not</span> <span class="n">empty</span></code> only stops being true after <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="k">some</span> <span class="n">f</span> <span class="p">:</span> <span class="n">File</span> <span class="o">|</span> <span class="n">delete</span><span class="o">[</span><span class="n">f</span><span class="o">]</span></code>, that is the trash can only be emptied after some file is deleted. If a file is never deleted then the trash bin can never be emptied again. By nesting this formula inside an <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="ow">always</span></code> we require it to hold in every state after an empty is performed. The <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="ow">after</span></code> used here is important, because without it we would require <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="o">(</span><span class="k">some</span> <span class="n">f</span> <span class="p">:</span> <span class="n">File</span> <span class="o">|</span> <span class="n">delete</span><span class="o">[</span><span class="n">f</span><span class="o">])</span> <span class="ow">releases</span> <span class="ow">not</span> <span class="n">empty</span></code> to hold in every state just before an empty is performed, and that would require <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="ow">not</span> <span class="n">empty</span></code> to already be true in that state, which would be a contradiction.</p>
<p id="index-18">All properties we checked so far are examples of <em>safety</em> properties, which are properties that forbid “bad” behaviors from happening. We can also specify and check <em>liveness</em> properties, that force some “good” behaviors to happen. For example, the following assertion states that every file that is deleted and never again restored will eventually disappear.</p>
<div class="highlight-electrum notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="nf">non_restored_files_will_disappear</span> <span class="o">{</span>
   <span class="k">all</span> <span class="n">f</span> <span class="p">:</span> <span class="n">File</span> <span class="o">|</span> <span class="ow">always</span> <span class="o">(</span>
      <span class="n">delete</span><span class="o">[</span><span class="n">f</span><span class="o">]</span> <span class="ow">and</span> <span class="ow">after</span> <span class="ow">always</span> <span class="ow">not</span> <span class="n">restore</span><span class="o">[</span><span class="n">f</span><span class="o">]</span> <span class="ow">implies</span>
      <span class="ow">eventually</span> <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">uploaded</span>
   <span class="o">)</span>
<span class="o">}</span>
<span class="k">check</span> <span class="n">non_restored_files_will_disappear</span>
</pre></div>
</div>
<p id="index-19">To satisfy this property the system is forced to make progress in a specific situation to produce the expected behavior, namely to eventually perform an empty when a file remains forever in the trash. Of course that will not be the case in our system because when a file is in the trash actions can still be performed in other files, and even if there is only one file that is deleted and never restored the system can still stutter forever. Allowing stuttering is a good practice, but sometimes we may wish to forbid unrealistic behaviors where the system opts to stutter forever, never making progress even if some action is enabled. The constraints that forbid those kinds of unrealistic behaviors are known as <em>fairness</em> restrictions, because they force the  environment to somehow be fair to the system allowing it to make progress once in a while. Fairness can be imposed on the whole system or on specific actions, and they are used many times to impose assumptions about the environment without having to specify in detail how it behaves. For example, when specifying concurrent algorithms it is common to impose restrictions  that force the system to be fair to all threads, allowing all of them to execute once in a while. This could  alternatively be achieved by specifying in detail how the operating system scheduler works, but when the focus is the verification of the concurrent algorithm that detail is unwelcome.</p>
<p>In our file sharing app, we actually expect the system to periodically empty the trash to free up resources. In the real system, this would probably be encoded with some sort of timer, but at this abstract level we just want to forbid behaviors where this action never occurs without having to detail how that process works. So we can impose a fairness restriction on the <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">empty</span></code> action, requiring it to eventually occur if at some point it becomes continuously enabled. That could be specified with the following fact.</p>
<div class="highlight-electrum notranslate"><div class="highlight"><pre><span></span><span class="k">fact</span> <span class="nf">fairness_on_empty</span> <span class="o">{</span>
   <span class="ow">always</span> <span class="o">(</span>
      <span class="ow">always</span> <span class="k">some</span> <span class="n">trashed</span> <span class="ow">implies</span>
      <span class="ow">eventually</span> <span class="n">empty</span>
   <span class="o">)</span>
<span class="o">}</span>
</pre></div>
</div>
<p>With this fact the above assertion <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">non_restored_files_will_disappear</span></code> becomes valid, because if a deleted file is never restored then action <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="n">empty</span></code> will be always enabled and thus required to eventually occur, causing the file to be removed from the uploads.</p>
<p id="index-20">As already discussed in chapter <a class="reference internal" href="../structural-modeling/index.html#structural-modeling"><span class="std std-ref">Structural modeling</span></a>, it is important to stress that the fact that a check command yields no counter-example instances only means that the
assertion is most likely valid. Recall that every command has a, sometimes implicit,
scope on top-level signatures. For example, the following command (the first in this section) only checks if the invariant assertion
is valid for configurations with up to 3 files and up to 3 tokens.</p>
<div class="highlight-electrum notranslate"><div class="highlight"><pre><span></span><span class="k">check</span> <span class="n">shared_are_accessible</span>
</pre></div>
</div>
<p>In Alloy, commands
also have a scope on the size of the finite prefix of traces that
precedes the mandatory back loop. By default this scope is 10, meaning
that the verification engine only checks for counter-example traces with at
most 10 different states (and transitions). This is a verification
technique known as <em>bounded model checking</em>. The Alloy Analyzer
searches for counter-examples of increasing length, and is guaranteed
to return the shortest one, if some exists. To change this bound just
assign a different value to the special scope <code class="code highlight alloy electrum docutils literal highlight-electrum"><span class="k">steps</span></code>. For example, to
verify the same assertion for systems with up to 4 files and tokens and
traces with at most 20 different states the scope could be set as
follows.</p>
<div class="highlight-electrum notranslate"><div class="highlight"><pre><span></span><span class="k">check</span> <span class="n">shared_are_accessible</span> <span class="k">for</span> <span class="mi">4</span> <span class="k">but</span> <span class="mi">20</span> <span class="k">steps</span>
</pre></div>
</div>
<p id="index-22"><span id="index-21"></span>This command also yields no counter-examples. With such a large scope it is
thus very likely that our assertion is indeed valid. In Alloy the analysis is
always bounded in respect to the signatures, but we can perform <em>unbounded model
checking</em> (or <em>complete model checking</em>) in respect to the size of the traces,
essentially verifying properties for traces composed by an arbitrary number of
states (which is necessarily finite since the signatures are bounded). To do so we must first choose a <em>solver</em> in the <span class="guilabel">Options</span>
menu that supports unbounded model checking. At the moment only the
<code class="code docutils literal notranslate"><span class="pre">nuXmv</span></code> or <code class="code docutils literal notranslate"><span class="pre">NuSMV</span></code> solvers support that feature. The solver is the low-level verification tool
that the Analyzer uses in the backend to perform the actual search for
instances and counter-examples. These two solvers are well-known model checkers and must be installed separately from the Alloy Analyzer.
For bounded model checking, many different
solvers can be used, including the two above but also several SAT solvers that came packaged with the Analyzer. Notice that some solvers may be considerably faster than others in
particular examples, so it is always worthwhile to try different options if your
analysis commands are very slow. To verify our property for systems with
up to 4 items and traces of any length the scope would need to be set as follows.</p>
<div class="highlight-electrum notranslate"><div class="highlight"><pre><span></span><span class="k">check</span> <span class="n">shared_are_accessible</span> <span class="k">for</span> <span class="mi">4</span> <span class="k">but</span> <span class="mi">1</span><span class="o">..</span> <span class="k">steps</span>
</pre></div>
</div>
<div class="sd-sphinx-override sd-cards-carousel sd-card-cols-2 docutils">
<div class="sd-card sd-sphinx-override sd-mb-3 sd-shadow-sm sd-card-hover docutils">
<div class="sd-card-header docutils">
<p class="sd-card-text"><svg version="1.1" width="1.0em" height="1.0em" class="sd-octicon sd-octicon-link" viewBox="0 0 16 16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg> Further reading</p>
</div>
<div class="sd-card-body docutils">
<div class="sd-card-title sd-font-weight-bold docutils">
A temporal logic primer</div>
<p class="sd-card-text">Read about the full syntax and semantics of the temporal logic supported in Alloy.</p>
</div>
<a class="sd-stretched-link reference internal" href="../behavioral-topics/topics/temporal-logic/index.html#temporal-logic"><span class="std std-ref"></span></a></div>
<div class="sd-card sd-sphinx-override sd-mb-3 sd-shadow-sm sd-card-hover docutils">
<div class="sd-card-header docutils">
<p class="sd-card-text"><svg version="1.1" width="1.0em" height="1.0em" class="sd-octicon sd-octicon-link" viewBox="0 0 16 16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg> Further reading</p>
</div>
<div class="sd-card-body docutils">
<div class="sd-card-title sd-font-weight-bold docutils">
Fairness and liveness</div>
<p class="sd-card-text">Learn more about liveness and fairness.</p>
</div>
<a class="sd-stretched-link reference internal" href="../behavioral-topics/topics/fairness/index.html#enabled"><span class="std std-ref"></span></a></div>
</div>
</section>
<section id="wrap-up">
<h2>Wrap-up<a class="headerlink" href="#wrap-up" title="Link to this heading">#</a></h2>
<div class="highlight-electrum notranslate"><div class="highlight"><pre><span></span><span class="kn">module</span> <span class="nn">filesharing</span>

<span class="kd">sig</span> <span class="nc">Token</span> <span class="o">{}</span>

<span class="kd">sig</span> <span class="nc">File</span> <span class="o">{</span>
    <span class="k">var</span> <span class="n">shared</span> <span class="p">:</span> <span class="k">set</span> <span class="n">Token</span>
<span class="o">}</span>
<span class="k">var</span> <span class="kd">sig</span> <span class="nc">uploaded</span> <span class="k">in</span> <span class="nc">File</span> <span class="o">{}</span>
<span class="k">var</span> <span class="kd">sig</span> <span class="nc">trashed</span> <span class="k">in</span> <span class="nc">uploaded</span> <span class="o">{}</span>

<span class="k">fact</span> <span class="nf">init</span> <span class="o">{</span>
    <span class="c1">// Initially there are no files uploaded nor shared</span>
    <span class="k">no</span> <span class="n">uploaded</span>
    <span class="k">no</span> <span class="n">shared</span>
<span class="o">}</span>

<span class="c1">// Superseded by fact transitions_or_stutter</span>
<span class="c1">// fact transitions {</span>
<span class="c1">//     // The system must only evolve according to the defined actions</span>
<span class="c1">//     always (</span>
<span class="c1">//         (some f : File | upload[f] or delete[f] or restore[f]) or</span>
<span class="c1">//         (some f : File, t : Token | share[f,t]) or</span>
<span class="c1">//         (some t : Token | download[t]) or</span>
<span class="c1">//         empty</span>
<span class="c1">//    )</span>
<span class="c1">// }</span>

<span class="k">fact</span> <span class="nf">transitions_or_stutter</span> <span class="o">{</span>
    <span class="c1">// The system either evolves according to the defined actions or stutters</span>
    <span class="ow">always</span> <span class="o">(</span>
        <span class="o">(</span><span class="k">some</span> <span class="n">f</span> <span class="p">:</span> <span class="n">File</span> <span class="o">|</span> <span class="n">upload</span><span class="o">[</span><span class="n">f</span><span class="o">]</span> <span class="ow">or</span> <span class="n">delete</span><span class="o">[</span><span class="n">f</span><span class="o">]</span> <span class="ow">or</span> <span class="n">restore</span><span class="o">[</span><span class="n">f</span><span class="o">])</span> <span class="ow">or</span>
        <span class="o">(</span><span class="k">some</span> <span class="n">f</span> <span class="p">:</span> <span class="n">File</span><span class="p">,</span> <span class="n">t</span> <span class="p">:</span> <span class="n">Token</span> <span class="o">|</span> <span class="n">share</span><span class="o">[</span><span class="n">f</span><span class="p">,</span><span class="n">t</span><span class="o">])</span> <span class="ow">or</span>
        <span class="o">(</span><span class="k">some</span> <span class="n">t</span> <span class="p">:</span> <span class="n">Token</span> <span class="o">|</span> <span class="n">download</span><span class="o">[</span><span class="n">t</span><span class="o">])</span> <span class="ow">or</span>
        <span class="n">empty</span> <span class="ow">or</span>
        <span class="n">stutter</span>
    <span class="o">)</span>
<span class="o">}</span>   

<span class="k">pred</span> <span class="nf">empty</span> <span class="o">{</span>
    <span class="k">some</span> <span class="n">trashed</span>                        <span class="c1">// guard</span>
    <span class="k">no</span> <span class="n">trashed</span><span class="o">&#39;</span>                         <span class="c1">// effect on trashed</span>
    <span class="n">uploaded</span><span class="o">&#39;</span> <span class="o">=</span> <span class="n">uploaded</span> <span class="o">-</span> <span class="n">trashed</span>      <span class="c1">// effect on uploaded</span>
    <span class="n">shared</span><span class="o">&#39;</span> <span class="o">=</span> <span class="n">shared</span>                    <span class="c1">// no effect on shared</span>
<span class="o">}</span>

<span class="k">pred</span> <span class="nf">upload</span> <span class="o">[</span><span class="n">f</span> <span class="p">:</span> <span class="n">File</span><span class="o">]</span> <span class="o">{</span>
    <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">uploaded</span>                   <span class="c1">// guard</span>
    <span class="n">uploaded</span><span class="o">&#39;</span> <span class="o">=</span> <span class="n">uploaded</span> <span class="o">+</span> <span class="n">f</span>            <span class="c1">// effect on uploaded</span>
    <span class="n">trashed</span><span class="o">&#39;</span> <span class="o">=</span> <span class="n">trashed</span>                  <span class="c1">// no effect on trashed</span>
    <span class="n">shared</span><span class="o">&#39;</span> <span class="o">=</span> <span class="n">shared</span>                    <span class="c1">// no effect on shared</span>
<span class="o">}</span>

<span class="k">pred</span> <span class="nf">delete</span> <span class="o">[</span><span class="n">f</span> <span class="p">:</span> <span class="n">File</span><span class="o">]</span> <span class="o">{</span>
    <span class="n">f</span> <span class="ow">in</span> <span class="n">uploaded</span> <span class="o">-</span> <span class="n">trashed</span>             <span class="c1">// guard</span>
    <span class="n">trashed</span><span class="o">&#39;</span> <span class="o">=</span> <span class="n">trashed</span> <span class="o">+</span> <span class="n">f</span>              <span class="c1">// effect on trashed</span>
    <span class="n">shared</span><span class="o">&#39;</span> <span class="o">=</span> <span class="n">shared</span> <span class="o">-</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">Token</span>         <span class="c1">// effect on shared</span>
    <span class="n">uploaded</span><span class="o">&#39;</span> <span class="o">=</span> <span class="n">uploaded</span>                <span class="c1">// no effect on uploaded</span>
<span class="o">}</span>

<span class="k">pred</span> <span class="nf">restore</span> <span class="o">[</span><span class="n">f</span> <span class="p">:</span> <span class="n">File</span><span class="o">]</span> <span class="o">{</span>
    <span class="n">f</span> <span class="ow">in</span> <span class="n">trashed</span>                        <span class="c1">// guard</span>
    <span class="n">trashed</span><span class="o">&#39;</span> <span class="o">=</span> <span class="n">trashed</span> <span class="o">-</span> <span class="n">f</span>              <span class="c1">// effect on trashed</span>
    <span class="n">uploaded</span><span class="o">&#39;</span> <span class="o">=</span> <span class="n">uploaded</span>                <span class="c1">// no effect on uploaded</span>
    <span class="n">shared</span><span class="o">&#39;</span> <span class="o">=</span> <span class="n">shared</span>                    <span class="c1">// no effect on shared</span>
<span class="o">}</span>

<span class="k">pred</span> <span class="nf">share</span> <span class="o">[</span><span class="n">f</span> <span class="p">:</span> <span class="n">File</span><span class="p">,</span> <span class="n">t</span> <span class="p">:</span> <span class="n">Token</span><span class="o">]</span> <span class="o">{</span>
    <span class="n">f</span> <span class="ow">in</span> <span class="n">uploaded</span> <span class="o">-</span> <span class="n">trashed</span>             <span class="c1">// guard</span>
    <span class="ow">historically</span> <span class="n">t</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">File</span><span class="o">.</span><span class="n">shared</span>   <span class="c1">// guard</span>
    <span class="n">shared</span><span class="o">&#39;</span> <span class="o">=</span> <span class="n">shared</span> <span class="o">+</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">t</span>             <span class="c1">// effect on shared</span>
    <span class="n">uploaded</span><span class="o">&#39;</span> <span class="o">=</span> <span class="n">uploaded</span>                <span class="c1">// no effect on uploaded</span>
    <span class="n">trashed</span><span class="o">&#39;</span> <span class="o">=</span> <span class="n">trashed</span>                  <span class="c1">// no effect on trashed</span>
<span class="o">}</span>

<span class="k">pred</span> <span class="nf">download</span> <span class="o">[</span><span class="n">t</span> <span class="p">:</span> <span class="n">Token</span><span class="o">]</span> <span class="o">{</span>
    <span class="k">some</span> <span class="n">shared</span><span class="o">.</span><span class="n">t</span>                       <span class="c1">// guard   </span>
    <span class="n">shared</span><span class="o">&#39;</span> <span class="o">=</span> <span class="n">shared</span> <span class="o">-</span> <span class="n">File</span><span class="o">-&gt;</span><span class="n">t</span>          <span class="c1">// effect on shared</span>
    <span class="n">uploaded</span><span class="o">&#39;</span> <span class="o">=</span> <span class="n">uploaded</span>                <span class="c1">// no effect on uploaded</span>
    <span class="n">trashed</span><span class="o">&#39;</span> <span class="o">=</span> <span class="n">trashed</span>                  <span class="c1">// no effect on trashed</span>
<span class="o">}</span>

<span class="k">pred</span> <span class="nf">stutter</span> <span class="o">{</span>
    <span class="n">uploaded</span><span class="o">&#39;</span> <span class="o">=</span> <span class="n">uploaded</span>                <span class="c1">// no effect on uploaded</span>
    <span class="n">trashed</span><span class="o">&#39;</span> <span class="o">=</span> <span class="n">trashed</span>                  <span class="c1">// no effect on trashed</span>
    <span class="n">shared</span><span class="o">&#39;</span> <span class="o">=</span> <span class="n">shared</span>                    <span class="c1">// no effect on trashed</span>
<span class="o">}</span>

<span class="k">run</span> <span class="n">example</span> <span class="o">{}</span>

<span class="k">assert</span> <span class="nf">shared_are_accessible</span> <span class="o">{</span>
    <span class="ow">always</span> <span class="n">shared</span><span class="o">.</span><span class="n">Token</span> <span class="ow">in</span> <span class="n">uploaded</span> <span class="o">-</span> <span class="n">trashed</span>
<span class="o">}</span>
<span class="k">check</span> <span class="n">shared_are_accessible</span>
<span class="k">check</span> <span class="n">shared_are_accessible</span> <span class="k">for</span> <span class="mi">4</span> <span class="k">but</span> <span class="mi">20</span> <span class="k">steps</span>
<span class="k">check</span> <span class="n">shared_are_accessible</span> <span class="k">for</span> <span class="mi">4</span> <span class="k">but</span> <span class="mi">1</span><span class="o">..</span> <span class="k">steps</span>

<span class="k">assert</span> <span class="nf">restore_undos_delete</span> <span class="o">{</span>
    <span class="k">all</span> <span class="n">f</span> <span class="p">:</span> <span class="n">File</span> <span class="o">|</span> <span class="ow">always</span> <span class="o">(</span>
        <span class="n">delete</span><span class="o">[</span><span class="n">f</span><span class="o">]</span> <span class="ow">and</span> <span class="ow">after</span> <span class="n">restore</span><span class="o">[</span><span class="n">f</span><span class="o">]</span> <span class="ow">implies</span>
        <span class="n">uploaded</span><span class="o">&#39;&#39;</span> <span class="o">=</span> <span class="n">uploaded</span> <span class="ow">and</span> <span class="n">trashed</span><span class="o">&#39;&#39;</span> <span class="o">=</span> <span class="n">trashed</span> <span class="ow">and</span> <span class="n">shared</span><span class="o">&#39;&#39;</span> <span class="o">=</span> <span class="n">shared</span>
    <span class="o">)</span>
<span class="o">}</span>
<span class="k">check</span> <span class="n">restore_undos_delete</span>

<span class="k">fun</span> <span class="nf">downloaded</span> <span class="o">[</span><span class="n">t</span> <span class="p">:</span> <span class="n">Token</span><span class="o">]</span> <span class="p">:</span> <span class="k">set</span> <span class="n">File</span> <span class="o">{</span>
    <span class="o">{</span> <span class="n">f</span> <span class="p">:</span> <span class="n">File</span> <span class="o">|</span> <span class="ow">once</span> <span class="o">(</span><span class="n">download</span><span class="o">[</span><span class="n">t</span><span class="o">]</span> <span class="ow">and</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">shared</span><span class="o">)</span> <span class="o">}</span>
<span class="o">}</span>

<span class="k">assert</span> <span class="nf">one_download_per_token</span> <span class="o">{</span>
    <span class="c1">// Alternative formulation</span>
    <span class="c1">// all t : Token | always (</span>
    <span class="c1">//     download[t] implies</span>
    <span class="c1">//     after always not download[t]</span>
    <span class="c1">// )</span>

    <span class="k">all</span> <span class="n">t</span> <span class="p">:</span> <span class="n">Token</span> <span class="o">|</span> <span class="ow">always</span> <span class="k">lone</span> <span class="n">downloaded</span><span class="o">[</span><span class="n">t</span><span class="o">]</span>
<span class="o">}</span>

<span class="k">assert</span> <span class="nf">empty_after_restore</span> <span class="o">{</span>
    <span class="ow">always</span> <span class="o">(</span>
        <span class="n">empty</span> <span class="ow">implies</span>
        <span class="ow">after</span> <span class="o">((</span><span class="k">some</span> <span class="n">f</span> <span class="p">:</span> <span class="n">File</span> <span class="o">|</span> <span class="n">delete</span><span class="o">[</span><span class="n">f</span><span class="o">])</span> <span class="ow">releases</span> <span class="ow">not</span> <span class="n">empty</span><span class="o">)</span>
    <span class="o">)</span>
<span class="o">}</span>
<span class="k">check</span> <span class="n">empty_after_restore</span>

<span class="k">fact</span> <span class="nf">fairness_on_empty</span> <span class="o">{</span>
    <span class="ow">always</span> <span class="o">(</span>
        <span class="ow">always</span> <span class="k">some</span> <span class="n">trashed</span> <span class="ow">implies</span>
        <span class="ow">eventually</span> <span class="n">empty</span>
    <span class="o">)</span>
<span class="o">}</span>

<span class="k">assert</span> <span class="nf">non_restored_files_will_disappear</span> <span class="o">{</span>
    <span class="k">all</span> <span class="n">f</span> <span class="p">:</span> <span class="n">File</span> <span class="o">|</span> <span class="ow">always</span> <span class="o">(</span>
        <span class="n">delete</span><span class="o">[</span><span class="n">f</span><span class="o">]</span> <span class="ow">and</span> <span class="ow">after</span> <span class="ow">always</span> <span class="ow">not</span> <span class="n">restore</span><span class="o">[</span><span class="n">f</span><span class="o">]</span> <span class="ow">implies</span>
        <span class="ow">eventually</span> <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">uploaded</span>
    <span class="o">)</span>
<span class="o">}</span>
<span class="k">check</span> <span class="n">non_restored_files_will_disappear</span>
</pre></div>
</div>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="../behavioral-topics/index.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Behavioral quick reads</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="../structural-topics/topics/analysis/index.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Structural analysis</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2021-2024, Alcino Cunha, Nuno Macedo, Julien Brunel, David Chemouil
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Behavioral modeling</a><ul>
<li><a class="reference internal" href="#specifying-transition-systems">Specifying transition systems</a></li>
<li><a class="reference internal" href="#specifying-actions">Specifying actions</a></li>
<li><a class="reference internal" href="#stuttering">Stuttering</a></li>
<li><a class="reference internal" href="#validating-the-design">Validating the design</a></li>
<li><a class="reference internal" href="#verifying-expected-properties">Verifying expected properties</a></li>
<li><a class="reference internal" href="#wrap-up">Wrap-up</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../../_static/documentation_options.js?v=10f1778b"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/furo.js?v=32e29ea5"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/design-tabs.js?v=36754332"></script>
    </body>
</html>